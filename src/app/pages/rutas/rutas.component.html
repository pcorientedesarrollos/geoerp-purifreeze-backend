<mat-card class="form-card">
  <mat-card-header>
    <mat-card-title>Crear Nueva Ruta</mat-card-title>
    <mat-card-subtitle>Asigna los datos generales y luego añade las paradas.</mat-card-subtitle>
  </mat-card-header>

  <mat-card-content>
    <!-- 1. Datos de la Ruta (Encabezado) -->
    <h3 class="section-title">1. Datos Generales de la Ruta</h3>
    <form [formGroup]="rutaForm" class="header-form">
      <mat-form-field appearance="outline">
        <mat-label>Operador</mat-label>
        <mat-select formControlName="idUsuario" required>
          @for(op of operadores; track op.idUsuario){ <mat-option [value]="op.idUsuario">{{ op.usuario }}</mat-option> }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Unidad de Transporte</mat-label>
        <mat-select formControlName="idUnidadTransporte" required>
          @for(unidad of unidades; track unidad.idUnidadTransporte){ <mat-option [value]="unidad.idUnidadTransporte">{{ unidad.nombreUnidad }}</mat-option> }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Fecha de la Ruta</mat-label>
        <input matInput [matDatepicker]="picker" formControlName="fecha_hora" required>
        <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-datepicker #picker></mat-datepicker>
      </mat-form-field>
    </form>

    <mat-divider class="section-divider"></mat-divider>

    <!-- 2. Formulario para Añadir Paradas -->
    <h3 class="section-title">2. Añadir Parada a la Ruta</h3>
    <form [formGroup]="paradaForm" class="parada-form">
      <mat-form-field appearance="outline">
        <mat-label>Cliente</mat-label>
        <mat-select formControlName="idCliente" required>
          @for(c of clientes; track c.idcliente){ <mat-option [value]="c.idcliente">{{ c.nombreComercio }}</mat-option> }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Sucursal / Dirección del Cliente</mat-label>
        <mat-select formControlName="idSucursal" required [disabled]="!paradaForm.get('idCliente')?.value">
          @for(dir of direccionesFiltradas; track dir.idDireccion){ <mat-option [value]="dir.idDireccion">{{ dir.nombreSucursal }}</mat-option> }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Tipo de Servicio de la Parada</mat-label>
        <mat-select formControlName="idTipoServicio" required>
           @for(tipo of tiposDeServicio; track tipo.idTipoServicio){ <mat-option [value]="tipo.idTipoServicio">{{ tipo.nombre }}</mat-option> }
        </mat-select>
      </mat-form-field>
      
      <mat-form-field appearance="outline" class="full-span">
        <mat-label>Dirección (Autocompletado)</mat-label>
        <input matInput formControlName="direccion">
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-span">
        <mat-label>Notas (Opcional)</mat-label>
        <textarea matInput formControlName="notas" rows="2"></textarea>
      </mat-form-field>

      <div class="add-button-container full-span">
        <button mat-stroked-button color="primary" type="button" (click)="agregarParada()" [disabled]="paradaForm.invalid">
          <mat-icon>add_location_alt</mat-icon>
          Añadir Parada a la Lista
        </button>
      </div>
    </form>
    
    <mat-divider class="section-divider"></mat-divider>
    
    <!-- 3. Resumen de Paradas Agregadas -->
    <h3 class="section-title">3. Resumen de Paradas</h3>
    @if (paradasAgregadas.length > 0) {
      <div class="paradas-list-container">
        @for (parada of paradasAgregadas; track $index) {
          <mat-card class="parada-card" appearance="outlined">
            <mat-card-header>
              <mat-card-title>Parada #{{ $index + 1 }}</mat-card-title>
              <mat-card-subtitle>{{ getClienteNombre(parada.idCliente) }}</mat-card-subtitle>
              <span class="spacer"></span>
              <button mat-icon-button color="warn" (click)="eliminarParada($index)" aria-label="Eliminar esta parada">
                <mat-icon>delete_outline</mat-icon>
              </button>
            </mat-card-header>
            <mat-card-content class="parada-card-content">
              <div class="parada-detail">
                <mat-icon>store</mat-icon>
                <span><strong>Sucursal:</strong> {{ getSucursalNombre(parada.idSucursal) }}</span>
              </div>
              <div class="parada-detail">
                <mat-icon>miscellaneous_services</mat-icon>
                <span><strong>Servicio:</strong> {{ getTipoServicioNombre(parada.idTipoServicio) }}</span>
              </div>
              <div class="parada-detail">
                <mat-icon>pin_drop</mat-icon>
                <span><strong>Dirección:</strong> {{ parada.direccion }}</span>
              </div>
              @if(parada.notas) {
                <div class="parada-detail notas">
                  <mat-icon>notes</mat-icon>
                  <span><strong>Notas:</strong> {{ parada.notas }}</span>
                </div>
              }
            </mat-card-content>
          </mat-card>
        }
      </div>
    } @else {
      <div class="no-stops-message-container">
        <mat-icon class="no-stops-icon">info_outline</mat-icon>
        <p>Aún no se han agregado paradas a la ruta.</p>
      </div>
    }
  </mat-card-content>

  <mat-card-actions class="form-actions">
    <button mat-stroked-button type="button" (click)="cancelar()">Cancelar</button>
    <button mat-raised-button color="primary" (click)="guardarRuta()" [disabled]="rutaForm.invalid || paradasAgregadas.length === 0 || isSaving">
      @if (isSaving) {
        <span>Guardando...</span>
      } @else {
        <ng-container>
          <mat-icon>save</mat-icon>
          <span>Guardar Ruta Completa</span>
        </ng-container>
      }
    </button>
  </mat-card-actions>
</mat-card>